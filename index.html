<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>一点+1 积分器</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --fg:#e2e8f0; /* slate-200 */
      --muted:#94a3b8; /* slate-400 */
      --accent:#22c55e; /* green-500 */
      --card:#111827cc; /* translucent */
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% -10%, #1f2937, var(--bg));color:var(--fg);font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";}
    .app{height:100%;display:grid;place-items:center;}
    .wrap{width:min(680px,92vw);padding:20px;}
    .card{position:relative;background:var(--card);backdrop-filter: blur(8px);border:1px solid #33415555;border-radius:24px;box-shadow:0 10px 40px #0008;overflow:hidden}
    .screen{position:relative;display:grid;place-items:center;padding:48px 24px;min-height:min(70vh, 600px);}
    .num{font-weight:800;font-size: clamp(64px, 18vw, 144px);line-height:1;letter-spacing:-.02em;text-shadow:0 6px 24px #000a}
    .tapzone{position:absolute;inset:0;}
    .hud{position:absolute;inset:auto 16px 16px 16px;display:flex;gap:10px;justify-content:space-between;align-items:center;}
    .btns{display:flex;gap:10px;}
    button{appearance:none;border:1px solid #33415599;background:#0b1220cc;color:var(--fg);padding:10px 14px;border-radius:14px;font-weight:600;font-size:14px;cursor:pointer;backdrop-filter: blur(6px)}
    button:hover{background:#0b1220ee}
    .primary{background:linear-gradient(180deg, #16a34a, #16a34a) padding-box, linear-gradient(180deg,#34d39955,#16a34a55) border-box;border:1px solid transparent;color:#052e16}
    .pill{position:absolute;top:14px;right:14px;background:#052e16;color:#86efac;border:1px solid #14532d;padding:6px 10px;border-radius:999px;font-size:12px;letter-spacing:.02em}
    .ghost{opacity:.7}
    .toast{position:fixed;left:50%;bottom:32px;transform:translateX(-50%);background:#0b1220;opacity:0;color:#e5e7eb;border:1px solid #334155;padding:10px 14px;border-radius:12px;transition:opacity .3s, transform .3s;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
    /* confetti */
    .confetti{position:absolute;pointer-events:none;inset:0;}
    .confetti i{position:absolute;width:8px;height:14px;opacity:0;}
  </style>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='0' y1='0' y2='1'%3E%3Cstop stop-color='%2322c55e'/%3E%3Cstop offset='1' stop-color='%2316a34a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='%230f172a'/%3E%3Ctext x='32' y='44' text-anchor='middle' font-size='40' font-weight='800' fill='url(%23g)'+ font-family='Arial,Helvetica,sans-serif'%3E%2B1%3C/text%3E%3C/svg%3E" />
</head>
<body>
  <div class="app">
    <div class="wrap">
      <div class="card" id="card">
        <span class="pill">一点 +1</span>
        <div class="screen">
          <div id="count" class="num" aria-live="polite">0</div>
          <div class="tapzone" id="tap" aria-label="点一下 +1" role="button"></div>
          <div class="hud">
            <div class="btns">
              <button id="undo" class="ghost" title="撤销上一步 (长按 -1)">撤销</button>
              <button id="reset" class="ghost" title="长按清零">清零</button>
            </div>
            <button id="add" class="primary" title="+1">+1</button>
          </div>
          <div class="confetti" id="confetti"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // --- State & persistence ---
    const KEY = 'oneTapPoints.count.v1'
    const EL = {
      count: document.getElementById('count'),
      tap: document.getElementById('tap'),
      add: document.getElementById('add'),
      undo: document.getElementById('undo'),
      reset: document.getElementById('reset'),
      toast: document.getElementById('toast'),
      confetti: document.getElementById('confetti'),
    }
    let count = +(localStorage.getItem(KEY) || 0)
    let last = null
    render()
    badge(count)

    function save(){ localStorage.setItem(KEY, String(count)); badge(count) }
    function render(){ EL.count.textContent = count }

    // --- Badge (if supported) ---
    async function badge(n){
      try{
        if('setAppBadge' in navigator) await navigator.setAppBadge(n)
        else if('setClientBadge' in navigator) await navigator.setClientBadge(n)
      }catch{ /* ignore */ }
    }

    // --- Confetti ---
    function burst(){
      const colors = ['#86efac','#34d399','#22c55e','#10b981','#bbf7d0']
      for(let i=0;i<14;i++){
        const p = document.createElement('i')
        p.style.left = Math.random()*100 + '%'
        p.style.top = '55%'
        p.style.background = colors[(Math.random()*colors.length)|0]
        p.style.transform = `rotate(${Math.random()*360|0}deg)`
        EL.confetti.appendChild(p)
        requestAnimationFrame(()=>{
          p.style.opacity = 1
          p.style.transition = 'transform .8s cubic-bezier(.2,.8,.2,1), opacity .9s'
          const dx = (Math.random()*2-1)*140
          const dy = - (120 + Math.random()*120)
          p.style.transform += ` translate(${dx}px, ${dy}px)`
          p.style.opacity = 0
          setTimeout(()=>p.remove(), 900)
        })
      }
    }

    // --- Toast ---
    let toastTimer
    function toast(msg){
      EL.toast.textContent = msg
      EL.toast.classList.add('show')
      clearTimeout(toastTimer)
      toastTimer = setTimeout(()=>EL.toast.classList.remove('show'), 1200)
    }

    // --- Actions ---
    function plusOne(){ last = count; count++; render(); save(); burst() }
    function minusOne(){ last = count; count = Math.max(0, count-1); render(); save() }
    function undo(){ if(last===null){ toast('没有可撤销的'); return } count = last; last = null; render(); save(); toast('已撤销') }
    function hardReset(){ last = count; count = 0; render(); save(); toast('已清零') }

    // Tap anywhere or click +1
    EL.tap.addEventListener('click', plusOne)
    EL.add.addEventListener('click', plusOne)

    // Undo button, long-press for -1
    EL.undo.addEventListener('click', undo)
    let undoPress
    EL.undo.addEventListener('pointerdown', ()=>{ undoPress = setTimeout(()=>{ minusOne(); toast('-1') }, 450) })
    EL.undo.addEventListener('pointerup', ()=> clearTimeout(undoPress))
    EL.undo.addEventListener('pointerleave', ()=> clearTimeout(undoPress))

    // Reset button (long-press)
    let resetPress
    EL.reset.addEventListener('pointerdown', ()=>{ resetPress = setTimeout(hardReset, 650) })
    EL.reset.addEventListener('pointerup', ()=> clearTimeout(resetPress))
    EL.reset.addEventListener('pointerleave', ()=> clearTimeout(resetPress))

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(['Space','Enter','NumpadAdd','+','='].includes(e.code) || ['+','='].includes(e.key)) plusOne()
      if(e.metaKey||e.ctrlKey){ if(e.key==='z') undo() }
    })

    // --- PWA: create manifest + service worker on the fly ---
    ;(function initPWA(){
      const manifest = {
        name: '一点+1 积分器',
        short_name: '+1',
        start_url: '.',
        display: 'standalone',
        background_color: '#0f172a',
        theme_color: '#0f172a',
        icons: [
          { src: iconSVG(), sizes: '192x192', type: 'image/svg+xml', purpose:'any' },
          { src: iconSVG(), sizes: '512x512', type: 'image/svg+xml', purpose:'any' }
        ]
      }
      const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'})
      const url = URL.createObjectURL(blob)
      const link = document.createElement('link'); link.rel='manifest'; link.href = url; document.head.appendChild(link)

      // Minimal offline support
      const swCode = `self.addEventListener('install', e=>{ e.waitUntil(caches.open('one-tap-v1').then(c=>c.addAll(['./'])) ) });
        self.addEventListener('fetch', e=>{ e.respondWith(fetch(e.request).catch(()=>caches.match('./'))) })`
      const swBlob = new Blob([swCode], {type:'text/javascript'})
      const swURL = URL.createObjectURL(swBlob)
      if('serviceWorker' in navigator){ navigator.serviceWorker.register(swURL) }
    })()

    function iconSVG(){
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop stop-color="#22c55e"/><stop offset="1" stop-color="#16a34a"/></linearGradient></defs><rect width="64" height="64" rx="14" fill="#0f172a"/><text x="32" y="44" text-anchor="middle" font-size="40" font-weight="800" fill="url(#g)" font-family="Arial,Helvetica,sans-serif">+1</text></svg>`
      return 'data:image/svg+xml;base64,'+btoa(svg)
    }

    // First use hint
    if(!localStorage.getItem(KEY+'_hinted')){
      localStorage.setItem(KEY+'_hinted','1')
      toast('轻触屏幕任意处：+1')
    }
  </script>
</body>
</html>
